<div id="shop-header" class="col d-flex flex-column align-items-center text-uppercase p-3">
    <div class="section-title font-staatliches">Cart</div>
</div>

<div id="decorative-divider" class="col d-flex flex-column align-items-center">
    <%= image_tag "patron_decorativo.png", class: "img-fluid" %>
</div>


<div class="container my-5">
  <% if @cart.cart_products.any? %>
    <div id="cart_content" class="row g-5">
      
      <div class="col-lg-7">
        <h2 class="mb-4 fs-3 text-uppercase">Summary</h2>

        <div class="table-responsive">
          <table class="table align-middle font-staatliches">
            <thead class="table-light">
              <tr>
                <th scope="col">Product</th>
                <th scope="col" class="text-center">Quantity</th>
                <th scope="col" class="text-end">Price (per unit)</th>
                <th scope="col" class="text-end">Subtotal</th>
              </tr>
            </thead>
            <tbody>
              <% @cart.cart_products.each do |item| %>
                <%= render 'shop/cart_product_row', item: item %>
              <% end %>
            </tbody>
            
            <%# CAMBIO AQUÍ: ID correcto para el Turbo Stream %>
            <tfoot id="order_summary_totals">
              <tr id="cart_total_row">
                <th colspan="3" class="text-end fs-5 pt-3">TOTAL:</th>
                <td class="text-end fs-5 pt-3 fw-bold text-success"><%= number_to_currency(@cart.cart_total) %></td>
              </tr>
            </tfoot>
          </table>
        </div>
        <hr class="my-4">
        
        
      </div>
      
      <div class="col-lg-5">
        <div class="card shadow-sm border-light">
          <div class="card-body p-4">
            <h2 class="mb-4 fs-3 text-uppercase">Order details</h2>
            
            <%# Utilizamos un formulario genérico. Asumimos una ruta POST a confirm_order_path %>
            <%= form_with url: confirm_order_path, method: :post, local: true do |f| %>

              <h4 class="mb-3 text-primary text-uppercase">Contact Information</h4>
              <div class="row g-3 mb-4 text-uppercase font-staatliches">
                <div class="col-sm-6">
                  
                  <%= f.text_field :customer_name, class: "form-control", required: true, placeholder: "Name" %>
                </div>
                <div class="col-sm-6">

                  <div id="delivery_cost"></div>
                  
                  <%= f.text_field :customer_phone, class: "form-control", required: true, placeholder: "Phone number" %>
                </div>
                <div class="col-12">
                  
                  <%= f.email_field :customer_email, class: "form-control", placeholder: "Email address" %>
                </div>
              </div>

              <h4 class="mb-3 text-primary text-uppercase">Shipping Address</h4>

              <div class="container mt-4" data-controller="shipping-map">
                

                <div class="mb-3">
                  <label class="form-label text-uppercase">Selected Address:</label>
                  <div id="address-display" class="p-2 border bg-light rounded text-muted">
                    Click on the map to select your location
                  </div>
                </div>

                <div id="map" style="height: 400px; width: 100%; border-radius: 8px; border: 1px solid #ddd; z-index: 1;"></div>

                <input type="hidden" id="postal_code" name="order[postal_code]">
                <input type="hidden" id="country_code" name="order[country_code]">
                <input type="hidden" id="shipping_address" name="order[shipping_address]" required="true">
              </div>
              
              <hr class="my-4">
              <%# CAMBIO AQUÍ: Contenedor para el mensaje del costo de envío %>
                <div id="fee_message" class="mb-3">
                  <%# Mensaje inicial para guiar al usuario %>
                  <div class="alert alert-warning py-2 small">
                    Please select a shipping location on the map to enable payment.
                  </div>
                </div>
              <%# f.submit "Confirm order (Pay)", class: "w-100 btn btn-primary btn-lg font-jaro text-uppercase p-3" %>
              <%= button_to "Pay", payments_path, method: :post, class: "w-100 btn btn-primary btn-lg font-jaro text-uppercase p-3", data: { turbo: false } %>
            <% end %>
          </div>
        </div>
      </div>
      
    </div>
  <% else %>
    <div class="alert text-center py-4">
      <p class="mb-0 fs-5 text-uppercase font-jaro">Your cart is empty. ¡Add some products!</p>
      <%= link_to "Go to the shop", "/shop/index", class: "btn btn-primary mt-3 font-jaro text-uppercase p-3" %>
    </div>
  <% end %>
</div>
