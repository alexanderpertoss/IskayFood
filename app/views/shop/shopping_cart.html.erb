<div id="shop-header" class="col d-flex flex-column align-items-center text-uppercase p-3">
    <div class="section-title font-staatliches">Cart</div>
</div>

<div id="decorative-divider" class="col d-flex flex-column align-items-center">
    <%= image_tag "patron_decorativo.png", class: "img-fluid" %>
</div>


<div class="container my-5">
  <% if @cart.cart_products.any? %>
    <div id="cart_content" class="row g-5">
      
      <div class="col-lg-7">
        <h2 class="mb-4 fs-3 text-uppercase">Summary</h2>

        <div class="table-responsive">
          <table class="table align-middle font-staatliches">
            <thead class="table-light">
              <tr>
                <th scope="col">Product</th>
                <th scope="col" class="text-center">Quantity</th>
                <th scope="col" class="text-end">Price (per unit</th>
                <th scope="col" class="text-end">Subtotal</th>
              </tr>
            </thead>
            <tbody>
              <% @cart.cart_products.each do |item| %>
                <%# LLAMAMOS AL PARTIAL PARA CADA FILA (Paso 2) %>
                <%= render 'shop/cart_product_row', item: item %>
              <% end %>
            </tbody>
            
            <tfoot>
              <%# ID DEL TOTAL GENERAL (Paso 3) %>
              <%= render 'shop/cart_total_row', cart: @cart %>
            </tfoot>
          </table>
        </div>
        <hr class="my-4">
        
        
      </div>
      
      <div class="col-lg-5">
        <div class="card shadow-sm border-light">
          <div class="card-body p-4">
            <h2 class="mb-4 fs-3 text-uppercase">Order details</h2>
            
            <%# Utilizamos un formulario gen√©rico. Asumimos una ruta POST a confirm_order_path %>
            <%= form_with url: confirm_order_path, method: :post, local: true do |f| %>

              <h4 class="mb-3 text-primary text-uppercase">Contact Information</h4>
              <div class="row g-3 mb-4 text-uppercase font-staatliches">
                <div class="col-sm-6">
                  
                  <%= f.text_field :customer_name, class: "form-control", required: true, placeholder: "Name" %>
                </div>
                <div class="col-sm-6">
                  
                  <%= f.text_field :customer_phone, class: "form-control", required: true, placeholder: "Phone number" %>
                </div>
                <div class="col-12">
                  
                  <%= f.email_field :customer_email, class: "form-control", placeholder: "Email address" %>
                </div>
              </div>

              <h4 class="mb-3 text-primary text-uppercase">Shipping Address</h4>

              <%# El controlador de Stimulus maneja la l√≥gica del mapa y los costos %>
              <div data-controller="map-selector">
                  
                  <div class="input-group mb-3">
                      <%# Este campo NO es el que se env√≠a, es solo para buscar %>
                      <input type="text" class="form-control font-staatliches" placeholder="Search or click on map..." 
                            data-map-selector-target="addressInput" 
                            data-action="change->map-selector#geocode" 
                            aria-label="Address search">
                      <button type="button" class="btn btn-outline-secondary font-staatliches" data-action="map-selector#geocode">Search</button>
                  </div>

                  <div id="delivery-map" style="height: 300px; background-color: #f8f9fa; border: 1px solid #dee2e6; margin-bottom: 15px;" 
                      data-map-selector-target="mapContainer">
                      <p class="text-center p-5 text-muted">
                          üó∫Ô∏è Interactive Map Here. Click to select point or search address.
                      </p>
                  </div>
                  
                  <%= f.hidden_field :customer_shipping_address, data: { map_selector_target: "finalAddress" } %>

                  <%# Campo oculto: Guarda la tarifa de env√≠o para el env√≠o final de la orden %>
                  <%= f.hidden_field :delivery_fee, value: 0.00, data: { map_selector_target: "deliveryFeeInput" } %>

                  <%# Mensaje de retroalimentaci√≥n al usuario sobre la tarifa %>
                  <div class="alert alert-primary font-staatliches" data-map-selector-target="feeMessage">
                      Please select a delivery location on the map.
                  </div>
              </div>
              
              <hr class="my-4">
              
              <%= f.submit "Confirm order (Pay)", class: "w-100 btn btn-primary btn-lg font-jaro text-uppercase p-3" %>
            <% end %>
          </div>
        </div>
      </div>
      
    </div>
  <% else %>
    <div class="alert text-center py-4">
      <p class="mb-0 fs-5 text-uppercase font-jaro">Your cart is empty. ¬°Add some products!</p>
      <%= link_to "Go to the shop", "/shop/index", class: "btn btn-primary mt-3 font-jaro text-uppercase p-3" %>
    </div>
  <% end %>
</div>
