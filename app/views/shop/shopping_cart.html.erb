<div id="shop-header" class="col d-flex flex-column align-items-center text-uppercase p-3">
    <div class="section-title font-staatliches">Shopping cart</div>
</div>

<div id="decorative-divider" class="col d-flex flex-column align-items-center mb-5">
    <%= image_tag "patron_decorativo_grey.png", class: "img-fluid" %>
</div>

<div class="container mb-5">
  <% if @cart.cart_products.any? %>
    <div id="cart_content" class="row g-5">
      
      <%# COLUMNA IZQUIERDA: RESUMEN %>
      <div class="col-lg-7">
        <div class="d-flex justify-content-between align-items-end mb-4">
          <h2 class="fs-2 text-uppercase font-staatliches mb-0">Order Summary</h2>
          <span class="text-muted font-staatliches"><%= @cart.cart_products.count %> Items</span>
        </div>

        <div class="table-responsive">
          <table class="table align-middle custom-cart-table font-staatliches">
            <thead class="text-muted small">
              <tr>
                <th scope="col" class="border-0 ps-0">PRODUCT</th>
                <th scope="col" class="border-0 text-center">QTY</th>
                <th scope="col" class="border-0 text-end pe-0">SUBTOTAL</th>
              </tr>
            </thead>
            <tbody>
              <% @cart.cart_products.each do |item| %>
                <%= render 'shop/cart_product_row', item: item %>
              <% end %>
            </tbody>
          </table>
        </div>

        <div id="order_summary_totals" class="bg-light p-4 rounded-3 mt-4 border-start border-primary border-4">
           <div class="d-flex justify-content-between align-items-center" id="cart_total_row">
              <span class="fs-4 font-staatliches">TOTAL AMOUNT:</span>
              <span class="fs-3 fw-bold text-dark font-staatliches"><%= number_to_currency(@cart.cart_total) %></span>
           </div>
        </div>

        <div class="mt-4">
           <%= link_to "â† Continue Shopping", "/shop/index", class: "text-decoration-none text-muted font-staatliches small" %>
        </div>
      </div>
      
      <%# COLUMNA DERECHA: FORMULARIO %>
      <div class="col-lg-5">
        <div class="card shadow-lg border-0 rounded-4 sticky-lg-top" style="top: 120px; z-index: 10;">
          <div class="card-body p-4 p-xl-5">
            <h2 class="mb-4 fs-3 text-uppercase font-staatliches border-bottom pb-2 text-primary">Checkout Details</h2>
            
            <%= form_with url: confirm_order_path, method: :post, local: true do |f| %>

              <div class="mb-4">
                <p class="small text-muted font-staatliches mb-3">CONTACT INFORMATION</p>
                <div class="row g-3">
                  <div class="col-12">
                    <%= f.text_field :customer_name, class: "form-control custom-input-line", required: true, placeholder: "FULL NAME" %>
                  </div>
                  <div class="col-sm-6">
                    <%= f.text_field :customer_phone, class: "form-control custom-input-line", required: true, placeholder: "PHONE NUMBER" %>
                  </div>
                  <div class="col-sm-6">
                    <%= f.email_field :customer_email, class: "form-control custom-input-line", placeholder: "EMAIL" %>
                  </div>
                </div>
              </div>

              <div class="mb-4" data-controller="shipping-map">
                <p class="small text-muted font-staatliches mb-2">SHIPPING LOCATION</p>
                
                <div id="address-display" class="p-3 mb-3 border-0 bg-light rounded-3 small font-staatliches text-muted shadow-sm">
                  <i class="bi bi-geo-alt-fill me-2 text-primary"></i> 
                  <span>Click on the map to set delivery address</span>
                </div>

                <div id="map" class="shadow-sm rounded-3 mb-3 border" style="height: 300px; width: 100%;"></div>

                <%# Hidden fields %>
                <input type="hidden" id="postal_code" name="order[postal_code]">
                <input type="hidden" id="country_code" name="order[country_code]">
                <input type="hidden" id="shipping_address" name="order[shipping_address]" required="true">
              </div>
              
              <div id="fee_message" class="mb-4">
                <div class="alert alert-info py-3 border-0 rounded-3 small font-staatliches text-center shadow-sm">
                  <i class="bi bi-info-circle me-2"></i> Shipping cost will be calculated on the map.
                </div>
              </div>

              <%= button_to payments_path, method: :post, id: "pay-button", disabled: true, 
                  class: "w-100 btn btn-primary-custom py-3 font-anarrow fs-4 shadow", 
                  data: { turbo: false } do %>
                PROCEED TO PAYMENT <i class="bi bi-arrow-right ms-2"></i>
              <% end %>

            <% end %>
          </div>
        </div>
      </div>
      
    </div>
  <% else %>
    <div class="text-center py-5">
      <div class="mb-4">
         <i class="bi bi-cart-x text-muted" style="font-size: 5rem;"></i>
      </div>
      <h3 class="font-staatliches text-uppercase">Your bag is empty</h3>
      <%= link_to "DISCOVER OUR PRODUCTS", "/shop/index", class: "btn btn-primary-custom mt-3 px-5 py-3" %>
    </div>
  <% end %>
</div>